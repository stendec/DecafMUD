<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<meta name="generator" content="JsDoc Toolkit" />
		<title>DecafMUD Reference - decafmud.socket.websocket.js</title>
		<link href="../../css/default.css" type="text/css" rel="stylesheet" media="all" />
		<link href="../../css/shCoreDefault.css" type="text/css" rel="stylesheet" media="all" />
		<link href="../../css/shThemeDefault.css" type="text/css" rel="stylesheet" media="all" />
        <link href="../../img/favicon.ico" rel="shortcut icon" />
		<script type="text/javascript" src="../../js/shCore.js"></script>
		<script type="text/javascript" src="../../js/shBrushJScript.js"></script>
	</head>

	<body>
		<div id="header">
    <h1><a href="http://decafmud.stendec.me/">DecafMUD</a></h1>
    <p class="paren">{</p>
    <p>HTML + CSS + JavaScript</p>
    <p class="paren last-paren">}</p>
    <p>keep Java away from your browser</p>
    <div style="clear:both"></div>
</div>

		<div class="index">
			<div class="menu">
				<!-- begin publish.classesIndex -->
				<div align="center"><a href="../../index.html">Class Index</a> | <a href="../../files.html">File Index</a></div>

<h2 class="heading1">Classes</h2>

<ul class="classList">
	<li class="namespace builtin"><a href="../../symbols/_global_.html">_global_</a></li><li class="class"><a href="../../symbols/DecafMUD.html">DecafMUD</a></li><li class="namespace">&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../symbols/DecafMUD.plugins.html">.plugins</a></li><li class="nolink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.Display</li><li class="class">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../symbols/DecafMUD.plugins.Display.standard.html">.standard</a></li><li class="nolink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.Encoding</li><li class="namespace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../symbols/DecafMUD.plugins.Encoding.cp437.html">.cp437</a></li><li class="namespace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../symbols/DecafMUD.plugins.Encoding.iso88591.html">.iso88591</a></li><li class="namespace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../symbols/DecafMUD.plugins.Encoding.iso885915.html">.iso885915</a></li><li class="namespace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../symbols/DecafMUD.plugins.Encoding.utf8.html">.utf8</a></li><li class="nolink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.Interface</li><li class="class">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../symbols/DecafMUD.plugins.Interface.simple.html">.simple</a></li><li class="nolink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.Socket</li><li class="class">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../symbols/DecafMUD.plugins.Socket.websocket.html">.websocket</a></li><li class="nolink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.Storage</li><li class="class">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../symbols/DecafMUD.plugins.Storage.standard.html">.standard</a></li><li class="nolink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.Telopt</li><li class="class">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DecafMUD.plugins.Telopt.]</li><li class="class">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DecafMUD.plugins.Telopt.ï¿½</li><li class="namespace builtin"><a href="../../symbols/String.html">String</a></li>
</ul>

				<!-- end publish.classesIndex -->
			</div>
			
			<div class="fineprint" style="clear:both">
				
				Generated by <a href="http://code.google.com/p/jsdoc-toolkit/" target="_blank">JsDoc Toolkit</a> 2.4.0<br />
				HTML template: <a href="http://www.thebrightlines.com/2010/05/06/new-template-for-jsdoctoolkit-codeview/" target="_blank">Codeview</a><br />
				<a href="http://decafmud.stendec.me/">DecafMUD</a> &copy; 2010 Stendec
			</div>
		</div>
		
		<div class="content" style="max-width: none">
			<div class="innerContent">
				<h1 class="classTitle">Source <span>decafmud.socket.websocket.js</span></h1>
				
				<p class="description summary">
					<em>File: </em> /mud/decafmud/src/js/decafmud.socket.websocket.js
				</p>
				
				<div class="details props">
					<div class="innerProps">
						<a name="source"></a>
						
						<div class="sectionTitle">
							Hilighted Source
						</div>
						
						<pre class="brush: js; toolbar: false">/*!
 * DecafMUD v0.9.0
 * http://decafmud.stendec.me
 *
 * Copyright 2010, Stendec &lt;me@stendec.me>
 */

/**
 * @fileOverview DecafMUD Socket Provider: WebSocket
 * @author Stendec &lt;me@stendec.me>
 * @version 0.9.0
 */

(function(DecafMUD) {

/** &lt;p>This provides support for &lt;a href="http://dev.w3.org/html5/websockets/">HTML5 WebSockets&lt;/a>
 *  to {@link DecafMUD} as a way to connect to servers. This, in theory,
 *  allows DecafMUD to connect without needing in-browser plugins such as
 *  Flash, Java, or Silverlight to supply a socket.&lt;/p>
 *
 *  &lt;p>Unfortunately, WebSockets force us to use UTF-8 data, wrapped in a
 *  special protocol. And, while quite light, this extra protocol requires
 *  special software on the server to work.&lt;/p>
 *  
 *  &lt;p>See Green Lantern for letting WebSockets work with existing MUD
 *  servers.&lt;/p>
 * @name DecafWebSocket
 * @class DecafMUD Socket Provider: WebSocket
 * @requires &lt;a href="http://dev.w3.org/html5/websockets/#the-websocket-interface">WebSocket&lt;/a>
 * @property {boolean} connected This is true if the socket is connected to a
 *    remote host, otherwise it's false.
 * @exports DecafWebSocket as DecafMUD.plugins.Socket.websocket
 * @param {DecafMUD} decaf The instance of DecafMUD using this plugin.
 */
var DecafWebSocket = function DecafWebSocket(decaf) {
	// Store DecafMUD for later use.
	this.decaf = decaf;
}

// Storage of all the WebSockets
/** An associative array of WebSocket objects and their corresponding socket
 *  provider plugin instances. This is used internally with the event handlers
 *  to prevent an icky need for anonymous functions.
 * @type Object */
DecafWebSocket.sockets = {};

// State Variables
DecafWebSocket.prototype.host = undefined;
DecafWebSocket.prototype.port = undefined;
DecafWebSocket.prototype.connected = false;
DecafWebSocket.prototype.ready = false;

/** This stores a reference to the WebSocket object used by this socket provider
 *  plugin instance.
 * @private
 * @type WebSocket */
DecafWebSocket.prototype.websocket = null;

// Prepare the socket provider for use.
/** This ensures that WebSockets are indeed available and calls the
 *  {@link DecafMUD#socketReady} method to tell DecafMUD to proceed
 *  to the next step of the startup procedure. */
DecafWebSocket.prototype.setup = function() {
	// If WebSockets are available, immediately call the socketReady event of
	// our DecafMUD instance. Otherwise, error out.
	if ( "WebSocket" in window ) {
		this.ready = true;
		this.decaf.socketReady(this);
		return; }
	
	clearTimeout(this.decaf.timer);
	this.decaf.error("Unable to create a WebSocket. Does your browser support them? If not, try {0}.".tr(
		this.decaf, '&lt;a href="http://www.google.com/chrome" target="_blank">Google Chrome&lt;/a>'));
}

/** Connects to the remote server. All the necessary data is pulled from
 *  the {@link DecafMUD} instance's options, so there aren't any parameters. */
DecafWebSocket.prototype.connect = function() {
	// If we're connected, disconnect.
	if ( this.connected &amp;&amp; this.websocket ) {
		delete DecafWebSocket.sockets[this.websocket];
		this.websocket.close();
		this.websocket = null; }
	
	// Determine the port to connect on.
	var port = this.port;
	if ( port === undefined ) {
		port = this.decaf.options.set_socket.wsport;
		if ( port &lt; 1 || port > 65535 ) {
			port = this.decaf.options.set_socket.policyport; }
		if ( port === undefined ) {
			port = 843; }
		
		this.port = port;
	}
	
	// Set the path variable
	var path = this.decaf.options.set_socket.wspath;
	if ( ! path ) {
		path = 'port_' + this.decaf.options.port; }
	
	// Get the hostname
	var host = this.host;
	if ( host === undefined ) {
		host = this.decaf.options.host;
		if ( ! host ) {
			host = document.location.host; }
		
		this.host = host;
	}
	
	// Create the websocket and attach our events.
	var con = 'ws://' + host + ':' + port + '/' + path;
	this.decaf.debugString('WebSocket Connection String: ' + con);
	
	this.websocket = new WebSocket(con);
	DecafWebSocket.sockets[this.websocket] = this;
	
	this.websocket.onopen		= DecafWebSocket.onOpen;
	this.websocket.onclose		= DecafWebSocket.onClose;
	this.websocket.onmessage	= DecafWebSocket.onMessage;
}

/** Closes the current connection and cleans up the WebSocket object. */
DecafWebSocket.prototype.close = function() {
	this.connected = false;
	if ( this.websocket ) {
		delete DecafWebSocket.sockets[this.websocket];
		this.websocket.close();
		this.websocket = null; }
}

/** Ensure that the socket is connected to a remote server.
 * @example
 * // Make sure we're connected.
 * decaf.socket.assertConnected();
 * 
 * // Now do something.
 * decaf.socket.write("Blah blah blah...");
 * @private
 * @throws {String} If the socket is not connected. */
DecafWebSocket.prototype.assertConnected = function() {
	if ( ! this.connected || ! this.websocket ) {
		throw "DecafMUD is not currently connected."; }
}

/** Send data to the remote server.
 * @example
 * decaf.socket.write("This is my message!\n");
 * @param {String} data The data to send to the remote server. This must be a
 *    string consisting only of the bytes 0 to 255.
 * @throws {String} If the data cannot be written for any reason. */
DecafWebSocket.prototype.write = function(data) {
	this.assertConnected();
	if ( ! this.websocket.send(data) ) {
		throw "Error sending data to the server."; }
}

/** Called when the WebSocket's onOpen event fires. If the WebSocket's readyState
 *  is &lt;abbr title="1">OPEN&lt;/abbr>, then we set {@link DecafWebSocket#connected}
 *  to true and call {@link DecafMUD#socketConnected}.
 * @private
 * @event */
DecafWebSocket.onOpen = function() {
	var sock = DecafWebSocket.sockets[this];
	
	// Are we connected?
	if ( this.readyState === 1 ) {
		sock.connected = true;
		sock.decaf.socketConnected(); }
}

/** Called when the WebSocket's onClose event fires. If the socket was
 *  previously connected, then set {@link DecafWebSocket@connected} to
 *  false, clean up the WebSocket, and call {@link DecafMUD#socketClosed}.
 * @private
 * @event */
DecafWebSocket.onClose = function() {
	var sock = DecafWebSocket.sockets[this];
	
	// Were we connected?
	if ( sock.connected ) {
		sock.connected = false;
		sock.decaf.socketClosed();
		delete DecafWebSocket.sockets[this];
		sock.websocket = null; }
}

/** Called when the WebSocket's onMessage event fires. Simply pass the data
 *  along to the proper instance of {@link DecafMUD}.
 * @private
 * @event
 * @param {Object} event An event containing the received data.*/
DecafWebSocket.onMessage = function(event) {
	var sock = DecafWebSocket.sockets[this];
	
	// Pass the data on to DecafMUD.
	sock.decaf.socketData(event.data);
}

// Add this to DecafMUD
DecafMUD.plugins.Socket.websocket = DecafWebSocket;

})(DecafMUD);</pre>
					</div>
				</div>
				
			</div>
		</div>
		<script type="text/javascript">SyntaxHighlighter.all()</script>
	</body>
</html>
