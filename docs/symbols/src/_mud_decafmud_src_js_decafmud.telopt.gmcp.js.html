<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<meta name="generator" content="JsDoc Toolkit" />
		<title>DecafMUD Reference - decafmud.telopt.gmcp.js</title>
		<link href="../../css/default.css" type="text/css" rel="stylesheet" media="all" />
		<link href="../../css/shCoreDefault.css" type="text/css" rel="stylesheet" media="all" />
		<link href="../../css/shThemeDefault.css" type="text/css" rel="stylesheet" media="all" />
        <link href="../../img/favicon.ico" rel="shortcut icon" />
		<script type="text/javascript" src="../../js/shCore.js"></script>
		<script type="text/javascript" src="../../js/shBrushJScript.js"></script>
	</head>

	<body>
		<div id="header">
    <h1><a href="http://decafmud.stendec.me/">DecafMUD</a></h1>
    <p class="paren">{</p>
    <p>HTML + CSS + JavaScript</p>
    <p class="paren last-paren">}</p>
    <p>keep Java away from your browser</p>
    <div style="clear:both"></div>
</div>

		<div class="index">
			<div class="menu">
				<!-- begin publish.classesIndex -->
				<div align="center"><a href="../../index.html">Class Index</a> | <a href="../../files.html">File Index</a></div>

<h2 class="heading1">Classes</h2>

<ul class="classList">
	<li class="namespace builtin"><a href="../../symbols/_global_.html">_global_</a></li><li class="class"><a href="../../symbols/DecafMUD.html">DecafMUD</a></li><li class="namespace">&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../symbols/DecafMUD.plugins.html">.plugins</a></li><li class="nolink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.Display</li><li class="class">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../symbols/DecafMUD.plugins.Display.standard.html">.standard</a></li><li class="nolink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.Encoding</li><li class="namespace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../symbols/DecafMUD.plugins.Encoding.cp437.html">.cp437</a></li><li class="namespace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../symbols/DecafMUD.plugins.Encoding.iso88591.html">.iso88591</a></li><li class="namespace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../symbols/DecafMUD.plugins.Encoding.iso885915.html">.iso885915</a></li><li class="namespace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../symbols/DecafMUD.plugins.Encoding.utf8.html">.utf8</a></li><li class="nolink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.Interface</li><li class="class">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../symbols/DecafMUD.plugins.Interface.simple.html">.simple</a></li><li class="nolink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.Socket</li><li class="class">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../symbols/DecafMUD.plugins.Socket.websocket.html">.websocket</a></li><li class="nolink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.Storage</li><li class="class">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../symbols/DecafMUD.plugins.Storage.standard.html">.standard</a></li><li class="nolink">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.Telopt</li><li class="class">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DecafMUD.plugins.Telopt.]</li><li class="class">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DecafMUD.plugins.Telopt.�</li><li class="namespace builtin"><a href="../../symbols/String.html">String</a></li>
</ul>

				<!-- end publish.classesIndex -->
			</div>
			
			<div class="fineprint" style="clear:both">
				
				Generated by <a href="http://code.google.com/p/jsdoc-toolkit/" target="_blank">JsDoc Toolkit</a> 2.4.0<br />
				HTML template: <a href="http://www.thebrightlines.com/2010/05/06/new-template-for-jsdoctoolkit-codeview/" target="_blank">Codeview</a><br />
				<a href="http://decafmud.stendec.me/">DecafMUD</a> &copy; 2010 Stendec
			</div>
		</div>
		
		<div class="content" style="max-width: none">
			<div class="innerContent">
				<h1 class="classTitle">Source <span>decafmud.telopt.gmcp.js</span></h1>
				
				<p class="description summary">
					<em>File: </em> /mud/decafmud/src/js/decafmud.telopt.gmcp.js
				</p>
				
				<div class="details props">
					<div class="innerProps">
						<a name="source"></a>
						
						<div class="sectionTitle">
							Hilighted Source
						</div>
						
						<pre class="brush: js; toolbar: false">/*!
 * DecafMUD v0.9.0
 * http://decafmud.stendec.me
 *
 * Copyright 2010, Stendec &lt;me@stendec.me>
 */

/**
 * @fileOverview DecafMUD TELOPT Handler: GMCP
 * @author Stendec &lt;me@stendec.me>
 * @version 0.9.0
 */

(function(DecafMUD) {

// Shortcut the TELNET constants for ease of use.
var t = DecafMUD.TN;

/** Handles the TELNET option GMCP.
 * @name GMCP
 * @class DecafMUD TELOPT Handler: GMCP
 * @exports GMCP as DecafMUD.plugins.Telopt.�
 * @param {DecafMUD} decaf The instance of DecafMUD using this plugin. */
var GMCP = function(decaf) { this.decaf = decaf; this.decaf.gmcp = this; }
GMCP.prototype.pingDelay = 60;
GMCP.prototype.pingAverage = 0;
GMCP.prototype.pingCount = 0;
GMCP.prototype.pingWhen = undefined;
GMCP.prototype.pingTimer = undefined;

/** Helper for sending GMCP messages. */
GMCP.prototype.sendGMCP = function(pckg, data) {
	var out = '';
	if ( data !== undefined ) { 
		out = JSON.stringify([data]);
		out = ' ' + out.substr(1, out.length-2); }

	this.decaf.sendIAC(t.IAC + t.SB + t.GMCP + pckg + out + t.IAC + t.SE);
}

/** Abort the ping information on disconnect. */
GMCP.prototype._wont = GMCP.prototype.disconnect = function() {
	clearTimeout(this.pingTimer);
	this.pingAverage = 0;
	this.pingCount = 0; }

/** Send the Core.Hello message upon connecting. */
GMCP.prototype._will = function() {
	var g = this; setTimeout(function(){
		g.sendGMCP("Core.Hello", {
			"client"	: "DecafMUD",
			"version"	: DecafMUD.version.toString()
		});
	}, 0);
	
	// Also, start the ping loop.
	this.pingTimer = setTimeout(function(){g.ping();}, this.pingDelay*1000);
}

/** Send a ping. */
GMCP.prototype.ping = function() {
	var avg = undefined;
	if ( this.pingCount > 0 ) { avg = this.pingAverage; }
	this.sendGMCP("Core.Ping", avg);
	this.pingWhen = new Date();
	
	// Schedule a new ping.
	var g = this;
	this.pingTimer = setTimeout(function(){g.ping();}, this.pingDelay*1000);
}

/** Handle an incoming GMCP message. */
GMCP.prototype._sb = function(data) {
	// Find the end of the package.
	var ind = data.search(/[^A-Za-z0-9._]/), ret = false, pckg, out;
	if ( ind !== -1 ) {
		pckg = data.substr(0, ind);
		if ( ind + 1 !== data.length ) {
			out = JSON.parse('['+data.substr(ind+1)+']')[0]; }
	} else { pckg = data; }
	
	// If there's no package, return.
	if ( pckg.length === 0 ) { return; }
	
	// Debug it.
	if ( out !== undefined &amp;&amp; 'console' in window &amp;&amp; console.groupCollapsed ) {
		console.groupCollapsed('DecafMUD['+this.decaf.id+'] RCVD IAC SB GMCP "'+pckg+'" ... IAC SE');
		console.dir(out);
		console.groupEnd('DecafMUD['+this.decaf.id+'] RCVD IAC SB GMCP "'+pckg+'" ... IAC SE');
	} else { ret = true; }
	
	// Get the function
	var func = this.getFunction(pckg);
	
	// Call it.
	if ( func ) { func.call(this, out); }
	
	return ret; // We print our own debug info.
}

/** Command to find a given function. */
GMCP.prototype.getFunction = function(pckg) {
	var parts = pckg.split('.'), top = this.packages;
	while(parts.length > 0) {
		var part = parts.shift();
		if ( top[part] === undefined ) { return undefined; }
		top = top[part];
	}
	
	if (typeof top === 'function') { return top; }
	return undefined;
}

/** Helper to add 

/** The package structure. */
GMCP.prototype.packages = {};

/** PACKAGE: Core */
GMCP.prototype.packages.Core = {
	' version' : 1,
	
	'Ping' : function(data) {
		var n = new Date() - this.pingWhen;
		this.pingCount++;
		this.pingAverage = Math.ceil((n + (this.pingAverage * (this.pingCount-1))) / this.pingCount);
		console.debug('PING: {0}ms over {1} pings'.tr(this.decaf,this.pingAverage,this.pingCount));
	},

	'Goodbye' : function(data) {
		this.decaf.debugString('Reason for disconnect: {0}'.tr(this.decaf,data));
	}
};

// Expose it to DecafMUD
DecafMUD.plugins.Telopt[t.GMCP] = GMCP;
//DecafMUD.plugins.Telopt.gmcp = true;
})(DecafMUD);</pre>
					</div>
				</div>
				
			</div>
		</div>
		<script type="text/javascript">SyntaxHighlighter.all()</script>
	</body>
</html>
